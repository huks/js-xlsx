<!DOCTYPE html>
<!-- xlsx.js (C) 2013-present  SheetJS http://sheetjs.com -->
<!-- vim: set ts=2: -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>JS-XLSX Live Demo</title>
<style>
#drop{
	border:2px dashed #bbb;
	-moz-border-radius:5px;
	-webkit-border-radius:5px;
	border-radius:5px;
	padding:25px;
	text-align:center;
	font:20pt bold,"Vollkorn";color:#bbb
}
#b64data{
	width:100%;
}
</style>
</head>
<body>
<b>JS-XLSX (XLSX/XLSB/XLSM/XLS/XML/ODS) Live Demo</b><br />
Output Format:
<select name="format">
<option value="csv" selected> CSV</option>
<option value="json"> JSON</option>
<option value="form"> FORMULAE</option>
</select><br />
<!--<input type="radio" name="format" value="csv" checked> CSV<br>
<input type="radio" name="format" value="json"> JSON<br>
<input type="radio" name="format" value="form"> FORMULAE<br> -->

<div id="drop">Drop an XLSX / XLSM / XLSB / ODS / XLS / XML file here to see sheet data</div>
<p><input type="file" name="xlfile" id="xlf" /> ... or click here to select a file</p>
<textarea id="b64data">... or paste a base64-encoding here</textarea>
<input type="button" id="dotext" value="Click here to process the base64 text" onclick="b64it();"/><br />
Advanced Demo Options: <br />
Use Web Workers: (when available) <input type="checkbox" name="useworker" unchecked><br />
Use Transferrables: (when available) <input type="checkbox" name="xferable" checked><br />
Use readAsBinaryString: (when available) <input type="checkbox" name="userabs" checked><br />

<button onclick="download_xlsx()">Download</button>

<pre id="out"></pre>
<br />
<!-- uncomment the next line here and in xlsxworker.js for encoding support -->
<!--<script src="dist/cpexcel.js"></script>-->
<script src="shim.js"></script>
<script src="jszip.js"></script>
<script src="xlsx.js"></script>
<!-- uncomment the next line here and in xlsxworker.js for ODS support -->
<script src="ods.js"></script>
<!-- write xlsx -->
<script type="text/javascript" src="Blob.js"></script>
<script type="text/javascript" src="FileSaver.js"></script>
<script>
var wb_out;
var X = XLSX;
var XW = {
	/* worker message */
	msg: 'xlsx',
	/* worker scripts */
	rABS: './xlsxworker2.js',
	norABS: './xlsxworker1.js',
	noxfer: './xlsxworker.js'
};

var rABS = typeof FileReader !== "undefined" && typeof FileReader.prototype !== "undefined" && typeof FileReader.prototype.readAsBinaryString !== "undefined";
if(!rABS) {
	document.getElementsByName("userabs")[0].disabled = true;
	document.getElementsByName("userabs")[0].checked = false;
}

var use_worker = typeof Worker !== 'undefined';
if(!use_worker) {
	document.getElementsByName("useworker")[0].disabled = true;
	document.getElementsByName("useworker")[0].checked = false;
}

var transferable = use_worker;
if(!transferable) {
	document.getElementsByName("xferable")[0].disabled = true;
	document.getElementsByName("xferable")[0].checked = false;
}

var wtf_mode = false;

function fixdata(data) {
	var o = "", l = 0, w = 10240;
	for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint8Array(data.slice(l*w,l*w+w)));
	o+=String.fromCharCode.apply(null, new Uint8Array(data.slice(l*w)));
	return o;
}

function ab2str(data) {
	console.log("function.ab2str is called");
	var o = "", l = 0, w = 10240;
	for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint16Array(data.slice(l*w,l*w+w)));
	o+=String.fromCharCode.apply(null, new Uint16Array(data.slice(l*w)));
	return o;
}

function s2ab(s) {
	var b = new ArrayBuffer(s.length*2), v = new Uint16Array(b);
	for (var i=0; i != s.length; ++i) v[i] = s.charCodeAt(i);
	return [v, b];
}

function xw_noxfer(data, cb) {
	var worker = new Worker(XW.noxfer);
	worker.onmessage = function(e) {
		switch(e.data.t) {
			case 'ready': break;
			case 'e': console.error(e.data.d); break;
			case XW.msg: cb(JSON.parse(e.data.d)); break;
		}
	};
	var arr = rABS ? data : btoa(fixdata(data));
	worker.postMessage({d:arr,b:rABS});
}

function xw_xfer(data, cb) {
	console.log("function.xw_xfer is called");
	var worker = new Worker(rABS ? XW.rABS : XW.norABS);
	worker.onmessage = function(e) {
		switch(e.data.t) {
			case 'ready':
				//console.log("case: ready");
				break;
			case 'e':
				console.error(e.data.d);
				break;
			default:
				//console.log("case: default");
				xx=ab2str(e.data).replace(/\n/g,"\\n").replace(/\r/g,"\\r");
				console.log("function.xw_xfer done");
				cb(JSON.parse(xx)); // process_wb is called!!
				break;
		}
	};
	if(rABS) {
		console.log("function.xw_xfer rABS: TRUE");
		var val = s2ab(data);
		worker.postMessage(val[1], [val[1]]);
	} else {
		console.log("function.xw_xfer rABS: FALSE");
		worker.postMessage(data, [data]);
	}
}

function xw(data, cb) {
	transferable = document.getElementsByName("xferable")[0].checked;
	if(transferable) xw_xfer(data, cb);
	else xw_noxfer(data, cb);
}

function get_radio_value( radioName ) {
	var radios = document.getElementsByName( radioName );
	for( var i = 0; i < radios.length; i++ ) {
		if( radios[i].checked || radios.length === 1 ) {
			return radios[i].value;
		}
	}
}

function to_json(workbook) {
	var result = {};
	workbook.SheetNames.forEach(function(sheetName) {
		var roa = X.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
		if(roa.length > 0){
			result[sheetName] = roa;
		}
	});
	return result;
}

function to_csv(workbook) {
	console.log("function.to_csv is called"); // something goes wrong here...?
	var result = [];
	workbook.SheetNames.forEach(function(sheetName) {
		var csv = X.utils.sheet_to_csv(workbook.Sheets[sheetName]);
		if(csv.length > 0){
			result.push("SHEET: " + sheetName);
			result.push("");
			result.push(csv);
		}
	});
	return result.join("\n");
}

function to_formulae(workbook) {
	var result = [];
	workbook.SheetNames.forEach(function(sheetName) {
		var formulae = X.utils.get_formulae(workbook.Sheets[sheetName]);
		if(formulae.length > 0){
			result.push("SHEET: " + sheetName);
			result.push("");
			result.push(formulae.join("\n"));
		}
	});
	return result.join("\n");
}

var tarea = document.getElementById('b64data');
function b64it() {
	console.log("function.b64bit is called");
	if(typeof console !== 'undefined') console.log("onload", new Date());
	var wb = X.read(tarea.value, {type: 'base64',WTF:wtf_mode});
	process_wb(wb);
}

function work_cell(worksheet, address, value) {
	/*
	 * v: raw value
	 * w: formatted text (if applicable)
	 * 
	 * Built-in export utilities (such as the CSV exporter) will use the w text if it is available.
	 * To change a value, be sure to delete cell.w (or set it to undefined) before attempting to export.
	 * The utilities will regenerate the w text from the number format (cell.z) and the raw value if possible.
	 */
	var w_address = address;
	var w_cell = worksheet[w_address];
	w_cell.v = value;
}

function format_text_cell(worksheet, address, value) {
	var f_address = address;
	var f_cell = worksheet[f_address];
	f_cell.w = value;
}

function kiwi_wb(workbook) {
	/* Get worksheet */
	var first_sheet_name = workbook.SheetNames[0];
	var ws = workbook.Sheets[first_sheet_name];
	/* Copy worksheet */
	var ws_origin = ws;

	var kiwi_row_length = ws['!ref'].substr(4);
	console.log("kiwi_row_length: " + kiwi_row_length);

	work_cell(ws, "A1", "外部订单编号"); // external order number
	work_cell(ws, "B1", "商品条码"); // barcode
	work_cell(ws, "C1", "快递公司"); // courier company
	work_cell(ws, "D1", "收件人名字"); // recipient name
	work_cell(ws, "E1", "收件人身份证号"); // recipient id number
	work_cell(ws, "F1", "收件人省"); // recipient province
	work_cell(ws, "G1", "收件人市"); // recipient city
	work_cell(ws, "H1", "收件人县区"); // recipient country
	work_cell(ws, "I1", "收件人街道及门牌号"); // recipient street and house number
	work_cell(ws, "J1", "收件人联系电话"); // recipient contact phone
	work_cell(ws, "K1", "邮件地址"); // mail address
	work_cell(ws, "L1", "包裹重量（KG）"); // package weight (KG)
	work_cell(ws, "M1", "物品单价（RMB）"); // item unit price (RMB)
	work_cell(ws, "N1", "物品数量"); // number of the stuffs
	work_cell(ws, "O1", "支付方式"); // payment method
	work_cell(ws, "P1", "商品名称"); // product name
	work_cell(ws, "Q1", "订单生成时间（年-月-日 时:分:秒）"); // order generation time
	work_cell(ws, "R1", "购买人平台ID"); // purchaser platform id
	work_cell(ws, "S1", "RACK NUMBER"); // rack number
	work_cell(ws, "T1", "");
	work_cell(ws, "U1", "");
	work_cell(ws, "V1", "");

	for(i=2;i<=kiwi_row_length;i++){
		/* external order number : order number(A1) OR original order number(E1) */
		work_cell(ws, "A"+[i], ws_origin["A"+[i]].w);
		/* barcode : WIP */
		work_cell(ws, "B"+[i], "BARCODE");
		/* courier company : logistics companies(O1) */
		work_cell(ws, "C"+[i], ws_origin["O"+[i]].w);
		/* recipient name : recipient(I1) */
		work_cell(ws, "D"+[i], ws_origin["I"+[i]].w);
		/* recipient id number : WIP */
		work_cell(ws, "E"+[i], "RECIPIENT_ID_NUMBER"); 		
		/* recipient province : provincial cities and counties(J1) */
		var string = ws_origin["J"+[i]].w;
		var strArray = string.split(" ");
		work_cell(ws, "F"+[i], strArray[0]);
		/* recipient city : WIP */
		work_cell(ws, "G"+[i], strArray[1]);
		/* recipient country : WIP */
		work_cell(ws, "H"+[i], strArray[2]);
		/* recipient recipient street and house number : address(K1) */
		work_cell(ws, "I"+[i], ws_origin["K"+[i]].w);
		/* recipient contact phone : phone(M1) */
		work_cell(ws, "J"+[i], ws_origin["M"+[i]].w);
		/* mail address : zip code(N1) */
		work_cell(ws, "K"+[i], ws_origin["N"+[i]].w);
		/* package weight (KG) : WIP */
		work_cell(ws, "L"+[i], "");
		/* item unit price (RMB) : price(S1) */
		work_cell(ws, "M"+[i], ws_origin["S"+[i]].w);
		/* number of the stuffs : real quantity(U1) */
		work_cell(ws, "N"+[i], ws_origin["U"+[i]].w);
		/* payment method : WIP */
		work_cell(ws, "O"+[i], "");
		/* product name : platform product name(R1) */
		work_cell(ws, "P"+[i], ws_origin["R"+[i]].w);
		/* order generation time : transaction time(F1) */
		work_cell(ws, "Q"+[i], ws_origin["F"+[i]].w);
		/* purchaser platform id : business code(Q1) */
		work_cell(ws, "R"+[i], ws_origin["Q"+[i]].w);
		/* rack number : shipment number(P1) */
		work_cell(ws, "S"+[i], ws_origin["P"+[i]].w);
		/* empty cells */
		work_cell(ws, "T"+[i], "");
		work_cell(ws, "U"+[i], "");
		work_cell(ws, "V"+[i], "");
	}	

	return workbook;	
}

function process_wb(wb) {
	console.log("function.process_wb is called");
	var output = "";

	wb_out = kiwi_wb(wb);

	switch(get_radio_value("format")) {
		case "json":
			console.log("output format: json");
			output = JSON.stringify(to_json(wb), 2, 2);
			break;
		case "form":
			output = to_formulae(wb);
			break;
		default:
			console.log("output format: csv");

			// wb_out = kiwi_wb(wb);		

			output = to_csv(wb_out);
	}
	if (out.innerText === undefined) {
		console.log("out.textContent:");
		out.textContent = output;
	} else {
		console.log("out.innerText:");
		out.innerText = output;
	} 
	if (typeof console !== 'undefined') {
		console.log("output", new Date());
	} 
}

function download_xlsx() {

	var wbout = XLSX.write(wb_out, {bookType:'xlsx', bookSST:true, type: 'binary'});

	function s2ab_blob(s) {
		var buf = new ArrayBuffer(s.length);
		var view = new Uint8Array(buf);
		for (var i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
		return buf;
	}

	saveAs(new Blob([s2ab_blob(wbout)],{type:"application/octet-stream"}), "test.xlsx")
}

var drop = document.getElementById('drop');
function handleDrop(e) {
	console.log("function.handleDrop is called");
	e.stopPropagation();
	e.preventDefault();
	rABS = document.getElementsByName("userabs")[0].checked;
	use_worker = document.getElementsByName("useworker")[0].checked;
	var files = e.dataTransfer.files;
	var f = files[0];
	{
		var reader = new FileReader();
		var name = f.name;
		reader.onload = function(e) {
			if(typeof console !== 'undefined') console.log("onload", new Date(), rABS, use_worker);
			var data = e.target.result;
			if(use_worker) {
				xw(data, process_wb);
			} else {
				var wb;
				if(rABS) {
					wb = X.read(data, {type: 'binary'});
				} else {
					var arr = fixdata(data);
					wb = X.read(btoa(arr), {type: 'base64'});
				}
				process_wb(wb);
			}
		};
		if(rABS) reader.readAsBinaryString(f);
		else reader.readAsArrayBuffer(f);
	}
}

function handleDragover(e) {
	e.stopPropagation();
	e.preventDefault();
	e.dataTransfer.dropEffect = 'copy';
}

if(drop.addEventListener) {
	drop.addEventListener('dragenter', handleDragover, false);
	drop.addEventListener('dragover', handleDragover, false);
	drop.addEventListener('drop', handleDrop, false);
}


var xlf = document.getElementById('xlf');
function handleFile(e) {
	console.log("function.handleFile is called");
	rABS = document.getElementsByName("userabs")[0].checked;
	use_worker = document.getElementsByName("useworker")[0].checked;
	var files = e.target.files;
	var f = files[0];
	{
		var reader = new FileReader();
		var name = f.name;
		reader.onload = function(e) {
			if(typeof console !== 'undefined') console.log("onload", new Date(), rABS, use_worker);
			var data = e.target.result;
			if(use_worker) {
				console.log("use_worker: TRUE");
				xw(data, process_wb);
			} else {
				console.log("use_worker: FALSE");
				var wb;
				if(rABS) {
					console.log("function.handleFile rABS: TRUE");
					wb = X.read(data, {type: 'binary', sheetStubs: 'false'});
				} else {
					console.log("function.handleFile rABS: FALSE");
					var arr = fixdata(data);
					wb = X.read(btoa(arr), {type: 'base64'});
				}
				process_wb(wb);
			}
		};
		if(rABS) reader.readAsBinaryString(f);
		else reader.readAsArrayBuffer(f);
	}
}

if(xlf.addEventListener) xlf.addEventListener('change', handleFile, false);
</script>
</body>
</html>
